#!/usr/bin/bash

source ./validate_name.sh
source ./validate_number.sh
source ./foreign_key_validation.sh

create_table() {

    table_path="$1"
    declare -a used_column_names=()
    pk_column=""

    ################ TABLE NAME ################
    while true; do

        tablename=$(zenity --entry \
            --title="Create Table" \
            --text="Enter the name of the table:")

        [[ -z "$tablename" ]] && continue

        if validate_name "$tablename"; then
            if [[ -f "$table_path/$tablename" ]]; then
                zenity --error --text="Table '$tablename' already exists!"
            else
                zenity --info --text="Valid table name."
                break
            fi
        else
            zenity --error --text="Invalid table name. Please try again."
        fi
    done

    ################ CREATE FILES ################
    touch "$table_path/$tablename"
    touch "$table_path/meta_$tablename"

    {
        echo "Table: $tablename"
        echo "Created: $(date)"
        echo "Columns:"
        echo "=========="
        echo "Column_No,Column_name,Data_type,Constraints"
        echo "-----------------------------"
    } >> "$table_path/meta_$tablename"

    ################ NUMBER OF COLUMNS ################
    while true; do
        No_columns=$(zenity --entry \
            --title="Number of Columns" \
            --text="Enter number of columns:")

        if validate_number "$No_columns"; then
            break
        else
            zenity --error --text="Invalid number."
        fi
    done

    ################ COLUMNS LOOP ################
    for ((i=1; i<=No_columns; i++)); do

        ################ COLUMN NAME ################
        while true; do
            column_name=$(zenity --entry \
                --title="Column $i" \
                --text="Enter name of column $i:")

            if ! validate_name "$column_name"; then
                zenity --error --text="Invalid column name."
                continue
            fi

            if [[ " ${used_column_names[*]} " =~ " $column_name " ]]; then
                zenity --error --text="Column name already used!"
            else
                used_column_names+=("$column_name")
                break
            fi
        done

        ################ DATA TYPE ################
        data_type=$(zenity --list \
            --title="Data Type" \
            --column="Type" \
            int string)

        ################ PRIMARY KEY ################
        constraints=""

        if [[ -z "$pk_column" ]]; then
            zenity --question --text="Make '$column_name' PRIMARY KEY?"
            if [[ $? -eq 0 ]]; then
                constraints="PRIMARY KEY"
                pk_column="$column_name"
            fi
        fi

        ################ OTHER CONSTRAINTS ################
        if [[ "$constraints" != "PRIMARY KEY" ]]; then

            choice=$(zenity --list \
                --title="Constraints" \
                --column="Option" --column="Constraint" \
                1 "NOT NULL" \
                2 "UNIQUE" \
                3 "FOREIGN KEY" \
                4 "None")

            case "$choice" in
                1) constraints="NOT NULL" ;;
                2) constraints="UNIQUE" ;;
                3)
                    zenity --info --text="Foreign key must reference a PRIMARY KEY"
                    fk_constraint=$(get_foreign_key "$column_name" "$data_type" "$table_path")
                    if [[ $? -eq 0 && -n "$fk_constraint" ]]; then
                        constraints="$fk_constraint"
                        zenity --info --text="Foreign key added."
                    else
                        zenity --warning --text="Foreign key not added."
                    fi
                    ;;
                4) constraints="None" ;;
            esac
        fi

        [[ -z "$constraints" ]] && constraints="None"

        ################ SAVE METADATA ################
        echo "Column$i,$column_name,$data_type,$constraints" \
            >> "$table_path/meta_$tablename"

    done

    ################ WRITE HEADER ################
    echo "${used_column_names[*]}" | tr ' ' ',' > "$table_path/$tablename"

    zenity --info \
        --title="Success" \
        --text="Table '$tablename' created successfully!"
}

create_table "$1"
