#!/usr/bin/bash

handel_pk() {
    hpk_num="$1" hrow_num="$2" hnew_value="$3" htable_full="$4"
    htable_path=$(dirname "$htable_full")/
    htable_name="${htable_full##*/}"
    
    # Check NULL
    if [[ -z "$hnew_value" ]]; then
        zenity --error --text="PK cannot be NULL" --title="Error"
        return 0
    fi

    # Check duplicate
    repeat=$(awk -F',' -v col="$hpk_num" -v val="$hnew_value" \
        'NR > 1 && $col == val { print NR }' "$htable_full")
    
    if [[ -n "$repeat" ]]; then
        zenity --error --text="Duplication not allowed for PK" --title="Duplicate PK"
        return 0
    fi
    
    old_value=$(awk -F',' -v col="$hpk_num" -v row="$hrow_num" \
        'NR == row { print $col }' "$htable_full")
    
    # Update main table
    awk -F',' -v OFS=',' -v col="$hpk_num" -v rn="$hrow_num" -v newval="$hnew_value" '
        { if (NR == rn) $col = newval; print $0 }
    ' "$htable_full" > "$htable_path/temp" && mv "$htable_path/temp" "$htable_full"
    
    # Update FKs in other tables
    for meta_tables in "$htable_path"meta_*; do
        col_num=$(grep -w "FOREIGN KEY REFERENCES $htable_name" "$meta_tables" 2>/dev/null | \
                  awk -F',' '{print $1}' | grep -o '[0-9]\+')
        
        if [[ -n "$col_num" ]]; then
            meta_name="${meta_tables##*/}"
            update_tablename="${meta_name#*_}"
            
            awk -F',' -v OFS=',' -v col="$col_num" -v o_value="$old_value" -v n_value="$hnew_value" '
                { if (NR != 1 && $col == o_value) $col = n_value; print $0 }
            ' "$htable_path$update_tablename" > "$htable_path/tmpfk" && \
            mv "$htable_path/tmpfk" "$htable_path$update_tablename"
        fi
    done
    
    zenity --info --text="PK updated successfully." --title="Success"
}

handel_fk() {
    fcol_num="$1" frow_num="$2" fnew_value="$3" ftable_full="$4" fpk_table="$5"
    ftable_path="$(dirname "$ftable_full")/"
    
    if [[ -z "$fnew_value" ]]; then
        awk -F',' -v OFS=',' -v col="$fcol_num" -v rn="$frow_num" '
            { if (NR == rn) $col = ""; print $0 }
        ' "$ftable_full" > "$ftable_path/tmpfk" && mv "$ftable_path/tmpfk" "$ftable_full"
        return 0
    fi
    
    pk_col_num_t2=$(grep -w "PRIMARY KEY" "${ftable_path}meta_${fpk_table}" 2>/dev/null | \
                    awk -F',' '{print $1}' | grep -o '[0-9]\+')
    
    search_for_new_val_in_pktable=$(awk -F',' -v col="$pk_col_num_t2" -v val="$fnew_value" \
        'NR > 1 && $col == val { print NR }' "${ftable_path}${fpk_table}")
    
    if [[ -z "$search_for_new_val_in_pktable" ]]; then
        zenity --error --text="Cannot find value '$fnew_value' in table '$fpk_table'" --title="Value Not Found"
        return 0
    fi
    
    awk -F',' -v OFS=',' -v col="$fcol_num" -v rn="$frow_num" -v val="$fnew_value" '
        { if (NR == rn) $col = val; print $0 }
    ' "$ftable_full" > "$ftable_path/tmpfk" && mv "$ftable_path/tmpfk" "$ftable_full"
}

update_table() {
    meta_path="$1" table_path="$1/"
    
    # Table name
    table_name=$(zenity --entry --title="Update Table" --text="Enter table name:" --width=400 --height=150)
    if [[ -z "$table_name" || ! -f "$table_path$table_name" ]]; then
        zenity --error --text="Error: Table '$table_name' does not exist." --title="Not Found"
        return 1
    fi
    
    # Column name
    column_name=$(zenity --entry --title="Update Column" --text="Enter column to update:" --width=400 --height=150)
    col_num=$(tail -n +7 "$meta_path/meta_$table_name" | awk -F',' -v col="$column_name" '$2 == col {print NR}')
    
    if [[ -z "$col_num" ]]; then
        zenity --error --text="Cannot find column '$column_name' in table '$table_name'" --title="Column Not Found"
        return 1
    fi
    
    data_type=$(sed -n "$((6 + col_num))p" "$meta_path/meta_$table_name" | cut -d',' -f3)
    new_value=$(zenity --entry --title="New Value" --text="Enter new value for $column_name ($data_type):" --width=400 --height=150)
    
    if [[ $new_value == *","* ]]; then
        zenity --error --text="Value cannot contain commas." --title="Input Error"
        return 0
    fi

    
    if [[ "$data_type" == "int" && ! "$new_value" =~ ^[0-9]*$ ]]; then
        zenity --error --text="Data type is INT. Enter valid integer." --title="Type Error"
        return 0
    fi
    
    PK_num=$(grep -w "PRIMARY KEY" "$meta_path/meta_$table_name" | awk -F',' '{print $1}' | grep -o '[0-9]\+')
    if [[ -z "$PK_num" ]]; then
        zenity --error --text="Cannot update table without PRIMARY KEY." --title="No PK"
        return 1
    fi
    
    pk_value=$(zenity --entry --title="PK Value" --text="Enter row's PK value:" --width=400 --height=150)
    row_number=$(awk -F',' -v col="$PK_num" -v pk="$pk_value" \
        '$col==pk && NR>1 {print NR}' "$table_path$table_name")
    
    if [[ -z "$row_number" ]]; then
        zenity --error --text="No row exists with PK '$pk_value'" --title="Row Not Found"
        return 1
    fi
    
    # Confirmation
    if zenity --question --title="Confirm Update" \
        --text="Update row PK '$pk_value':\n$column_name = '$new_value'?" \
        --width=450 --height=150; then
        
        if [[ "$col_num" == "$PK_num" ]]; then
            handel_pk "$PK_num" "$row_number" "$new_value" "$table_path$table_name"
        elif [[ "$(sed -n "$((6 + col_num))p" "$meta_path/meta_$table_name" | cut -d',' -f4)" == *"FOREIGN KEY REFERENCES"* ]]; then
            pk_table_name=$(sed -n "$((6 + col_num))p" "$meta_path/meta_$table_name" | cut -d',' -f4 | awk '{print $4}' | cut -d'(' -f1)
            handel_fk "$col_num" "$row_number" "$new_value" "$table_path$table_name" "$pk_table_name"
        else
            constraint=$(sed -n "$((6 + col_num))p" "$meta_path/meta_$table_name" | cut -d',' -f4)
            
            if [[ "$constraint" == *"NOT NULL"* && -z "$new_value" ]]; then
                zenity --error --text="Column does not allow NULL values" --title="NOT NULL"
                return 0
            fi
            
            if [[ "$constraint" == *"UNIQUE"* ]]; then
                repeat=$(awk -F',' -v col="$col_num" -v val="$new_value" \
                    'NR > 1 && $col == val { print NR }' "$table_path$table_name")
                if [[ -n "$repeat" ]]; then
                    zenity --error --text="Duplication not allowed" --title="UNIQUE Violation"
                    return 0
                fi
            fi
            
            awk -F',' -v OFS=',' -v col="$col_num" -v rn="$row_number" -v val="$new_value" '
                { if (NR == rn) $col = val; print $0 }
            ' "$table_path$table_name" > "$table_path/tmpfk" && mv "$table_path/tmpfk" "$table_path$table_name"
            zenity --info --text="Table updated successfully." --title="Success"
        fi
    else
        zenity --info --text="Update cancelled." --title="Cancelled"
    fi
}

update_table "$1"
